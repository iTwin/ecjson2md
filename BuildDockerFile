FROM debian:latest

# Name of the npm package to publish
ARG PACKAGE_NAME=ecjson2md

ENV DEBIAN_FRONTEND noninteractive

# Update package manager, upgrade system, install packages, and install nodejs/npm
RUN apt-get update && apt-get upgrade -y && apt-get install gnupg curl nuget mono-complete git -y && curl -sL https://deb.nodesource.com/setup_9.x | bash - && apt-get install nodejs -y

# Update NPM, install needed packages, and configure for anonymous package access
RUN npm install npm@latest -g && npm install -g typescript && npm config set @bentley:registry https://registry.npmjs.org/

## Configure git
# RUN git config --global user.email "" && git config --global user.name ""

# Add repo from context
ADD . /npm_package/

# Install the package
WORKDIR npm_package
RUN npm install

# Run tests, build, cover, and Pack
RUN node node_modules/@bentley/bentleyjs-tools/scripts/test-tsnode.js --testDir ./test/ --tscPaths && tsc && npm run cover && npm pack

WORKDIR /

# Update nuget and install BdfGenerator
RUN nuget update -self && nuget install -NonInteractive Bentley.BDF.Generator -Source 

WORKDIR /npm_package/

# Get the local version + latest commit and generate the bdf
RUN export locVersion=$(find bentley-${PACKAGE_NAME}-*.tgz | cut -d "-" -f3 | cut -c 1-5); \
    export latestCommit=$(git rev-parse HEAD); \
    mono /Bentley.BDF.Generator.*/tools/Bentley.BDF.Generator.exe --source /npm_package/ --name @bentley/${PACKAGE_NAME} --version $locVersion.0 --productid 123 --branch master --sourceurl Platform%20Technology/_git/${PACKAGE_NAME} --changeset $latestCommit --usePackageJson --buildtype npm --bdfout /npm_package/@bentley-${PACKAGE_NAME}.bdf;

# Set the local and server version variables in VSTS
RUN echo "##vso[task.setvariable variable=localVersion]$(find bentley-${PACKAGE_NAME}-*.tgz | cut -d - -f3 | cut -c 1-5)" && echo "##vso[task.setvariable variable=serverVersion]$(npm view @bentley/${PACKAGE_NAME} version)"

## Publish the bdf
# RUN bdfStuff=$(cat *.bdf); \
# curl \
#   --request POST \
#   --header "Content-Type: text/json" \
#   --header "From: " \
#   --data @${PACKAGE_NAME}.bdf ;